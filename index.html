<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Svt</title>
    <script src="js/pixi.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"
            integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
            crossorigin="anonymous"></script>
    <script src="js/jquery.slides.min.js"></script>
    <script src="js/environmentSetup.js"></script>
    <script src="js/collision.js"></script>
    <script src="js/keyboard.js"></script>
    <link rel="stylesheet" href="css/main.css">
</head>
<body>
<div class="content" id="content">
    <div class="background"></div>
    <div class="photoContainer">
        <div class="futbolmatch-slider slider">
            <img src="./assets/png/photos/futbolmatch2.png" height="100%">
            <img src="./assets/png/photos/futbolmatch3.jpg" height="100%">
            <img src="./assets/png/photos/futbolmatch4.jpg" height="100%">
            <img src="./assets/png/photos/futbolmatch5.jpg" height="100%">
        </div>
    </div>
</div>


<script type="text/javascript">

    //Aliases
    var Container = PIXI.Container,
        autoDetectRenderer = PIXI.autoDetectRenderer,
        loader = PIXI.loader,
        resources = PIXI.loader.resources,
        Sprite = PIXI.Sprite;

    var stage = new Container();
    var state;
    var contentDiv =  $("#content");
    var backgroundDiv =  $(".background");
    var screenWidth= contentDiv.width();
    var screenHeight = contentDiv.height()-4;
    var renderer = autoDetectRenderer(screenWidth, screenHeight,{ transparent: true });
    var zombie;
    var idleFrames = [];
    var walkingFrames = [];
    var attackingFrames = [];
    var pathTiles = [];
    var bushPositions = [0, 1290, 2400, 2600];
    var signPositions = [320];
    var futbolMatchScroll;
    var books = [];
    var clouds = [];
    var lever;
    var xScale = 0.2;
    var floorYPosition;
    var world;

    contentDiv.append(renderer.view);

    loader.add("./assets/png/male/Idle (1).png")
        .add("./assets/png/male/Idle (2).png")
        .add("./assets/png/male/Idle (3).png")
        .add("./assets/png/male/Idle (4).png")
        .add("./assets/png/male/Idle (5).png")
        .add("./assets/png/male/Idle (6).png")
        .add("./assets/png/male/Idle (7).png")
        .add("./assets/png/male/Idle (8).png")
        .add("./assets/png/male/Idle (9).png")
        .add("./assets/png/male/Idle (10).png")
        .add("./assets/png/male/Idle (11).png")
        .add("./assets/png/male/Idle (12).png")
        .add("./assets/png/male/Idle (13).png")
        .add("./assets/png/male/Idle (14).png")
        .add("./assets/png/male/Idle (15).png")
        .add("./assets/png/male/Walk (1).png")
        .add("./assets/png/male/Walk (2).png")
        .add("./assets/png/male/Walk (3).png")
        .add("./assets/png/male/Walk (4).png")
        .add("./assets/png/male/Walk (5).png")
        .add("./assets/png/male/Walk (6).png")
        .add("./assets/png/male/Walk (7).png")
        .add("./assets/png/male/Walk (8).png")
        .add("./assets/png/male/Walk (9).png")
        .add("./assets/png/male/Walk (10).png")
        .add("./assets/png/male/Attack (1).png")
        .add("./assets/png/male/Attack (2).png")
        .add("./assets/png/male/Attack (3).png")
        .add("./assets/png/male/Attack (4).png")
        .add("./assets/png/male/Attack (5).png")
        .add("./assets/png/male/Attack (6).png")
        .add("./assets/png/male/Attack (7).png")
        .add("./assets/png/male/Attack (8).png")
        .add("./assets/png/path/2.png")
        .add("./assets/png/path/5.png")
        .add("./assets/png/Object/Bush (1).png")
        .add("./assets/png/Object/Sign_2.png")
        .add("./assets/png/Object/building.png")
        .add("./assets/png/Object/cloud.png")
        .add("./assets/png/Object/lever left2.png")
        .add("./assets/png/Object/scroll_yellow.png")
        .add("./assets/png/books/book1.png")
        .add("./assets/png/books/book2.png")
        .add("./assets/png/books/book3.png")
        .add("./assets/png/books/book4.png")
        .add("./assets/png/books/book5.png")
        .add("./assets/png/books/book6.png")
        .load(setup);

    function setup() {

        setKeyboardFunctions();

        setEnvironment();

        renderer.render(stage);

        state = play;

    }


    function gameLoop() {
        requestAnimationFrame(gameLoop);
        state();
        renderer.render(stage);
    }

    function play() {
        processCharacterMovement();
        booksHitCollisions();
        cloudsHitCollisions();
        futbolMatchLeverHitCollision();
        updateFutbolmatchScrollPosition();
    }

    function updateFutbolmatchScrollPosition() {
        if(lever.active==true && futbolMatchScroll.y < 0){
            futbolMatchScroll.y += 7;
        }
    }


    function processCharacterMovement() {
        calculateFloorYPosition();
        var hitsLimits =  contain(zombie, {x: screenWidth * 0.2, y: 10, width: screenWidth*0.8, height: floorYPosition});
        if(hitsLimits==="right"){
            zombie.vx=0;
            world.vx = -5;
        }

        if( hitsLimits=="left"){
            zombie.vx=0;
            world.vx = 5;
        }

        if( hitsLimits=="bottom"){
            zombie.vy=0;
        }

        if(world.vx < 1 && world.x * -1 + screenWidth > pathTiles.length * pathTiles[0].width)
            world.vx = 0;
        if(world.vx > 1 && world.x > -10)
            world.vx = 0;
        if(zombie.vy != 0)
            zombie.vy += 0.4;


        zombie.x += zombie.vx;
        zombie.y += zombie.vy;
        world.x += world.vx;
        testFutbolmatchZone();

    }

    function testFutbolmatchZone(){
        if(world.x < -3500 + zombie.x && world.x > -6000 + zombie.x) {
            if(!backgroundDiv.hasClass("futbolmatch")){
                backgroundDiv.addClass("futbolmatch").addClass("fadeIn").removeClass("fadeOut");
            }
        }else {
            if(backgroundDiv.hasClass("futbolmatch")) {
                backgroundDiv.addClass("fadeOut").removeClass("fadeIn");
                setTimeout(function () {
                    backgroundDiv.removeClass("futbolmatch")
                },1990)
            }
        }
    }

    function walkAnimation(direction){
        zombie.textures = walkingFrames;
        zombie.scale.x = xScale * direction;
        zombie.state = "walking";
    }

    function idleAnimation() {
        zombie.textures = idleFrames;
        zombie.state = "idle";
    }

    function attackingAnimation() {
        zombie.textures = attackingFrames;
        zombie.state = "attacking";
    }

    function setEnvironment() {
        world = new Container();
        world.vx = 0;

        loadAnimationFrames();
        addPathTiles();
        addBushes();
        addSigns();
        addBuildings();
        addBooks();
        addFutbolmatchAssets();

        stage.addChild(world);

        zombie = new PIXI.extras.MovieClip(idleFrames);

        zombie.animationSpeed = 0.4;
        zombie.play();
        zombie.anchor.set(0.5);
        zombie.scale.set(xScale);
        zombie.vx = 0;
        zombie.vy = 0;
        calculateFloorYPosition();
        zombie.position.set(screenWidth * 0.2, floorYPosition );

        stage.addChild(zombie);
    }

    function loadAnimationFrames() {
        for (var i = 1; i <= 15; i++) {
            idleFrames.push(PIXI.Texture.fromFrame('./assets/png/male/Idle (' + i + ').png'));
        }

        for ( i = 1; i <= 10; i++) {
            walkingFrames.push(PIXI.Texture.fromFrame('./assets/png/male/Walk (' + i + ').png'));
        }

        for ( i = 1; i <= 8; i++) {
            attackingFrames.push(PIXI.Texture.fromFrame('./assets/png/male/Attack (' + i + ').png')); //504.5 450
        }
    }

    function setKeyboardFunctions() {

        var left = keyboard(37),
            right = keyboard(39),
            up = keyboard(38),
            down = keyboard(40),
            space = keyboard(32),
            esc = keyboard(27),
            ctrl = keyboard(17);

        left.press = function() {
            walkAnimation(-1);
            zombie.vx = -5;
        };

        left.release = function() {

            if (!right.isDown) {
                zombie.vx = 0;
                world.vx = 0;
                idleAnimation();
            }
        };

        right.press = function() {
            walkAnimation(1);
            zombie.vx = 5;
        };
        right.release = function() {
            if (!left.isDown ) {
                zombie.vx = 0;
                world.vx = 0;
                idleAnimation();
            }
        };

        space.press = function() {
            if(zombie.vy == 0)
                zombie.vy = -10;
        };

        ctrl.press = function() {
            attackingAnimation();
        };

        ctrl.release = function() {
            if(zombie.vx == 0 && world.vx == 0) {
                idleAnimation();
            }else{
                if(zombie.vx > 0 || world.vx < 0) {
                    walkAnimation(1);
                }else {
                    walkAnimation(-1);
                }
            }
        };

        esc.release = function () {
            $(".photoContainer").hide();
            $(".slider").css({"visibility": "hidden"});
        }
    }

    function calculateFloorYPosition (){
        floorYPosition =  (screenHeight - pathTiles[0].height) + zombie.height / 2 + 10;
    }

    gameLoop();

</script>
</body>
</html>